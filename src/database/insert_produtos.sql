-- Inserção dos produtos
INSERT INTO produtos (nome, referencia, categoria) VALUES 
    ('FRESA MD TOPO RETO 5,0X13', 'UP210-S4-05013', 'fresa'),
    ('FRESA MD TOPO RETO 2,0X6/5', 'UP210-S4-62006', 'fresa'),
    ('FRESA MD TOPO RETO 3,0X9/5', 'UP210-S4-63009', 'fresa'),
    ('FRESA MD TOPO RETO 4,0X11', 'UP210-S4-64011', 'fresa'),
    ('FRESA MD TOPO RETO 8,0X20', 'UP210-S4-08020', 'fresa'),
    ('FRESA MD TOPO RETO 10,0X25', 'UP210-S4-10025', 'fresa'),
    ('BROCA MD 6,0X44,0/82X6,0MM', 'D938-A5N-0600', 'broca'),
    ('FRESA MD TOPO RETO 6,0X16', 'UP210-S4-06016', 'fresa'),
    ('PASTILHA TNMG 160404R LV G', 'PTNMG160404R-LV-GM32', 'pastilha'),
    ('PASTILHA 16ERG60-TC-GM3225', 'P16ERG60-TC-GM3225', 'pastilha'),
    ('PASTILHA 16ERG55-TC-GM3225', 'P16ERG55-TC-GM3225', 'pastilha'),
    ('SUPORTE INT ROSQ SIR0020Q1', 'PSIR0020Q16', 'suporte'),
    ('PASTILHA 16ERAG60 TC GM322', 'P16ERAG60-TC-GM3225', 'pastilha'),
    ('PASTILHA 16IRAG60 TC GM322', 'P16IRAG60-TC-GM3225', 'pastilha'),
    ('FRESA MD TOROIDAL 6,0X16/5', 'UP210-R4-06005', 'fresa'),
    ('FRESA MD TOPO RETO 16,X36', 'UP210-S4-16036', 'fresa'),
    ('FRESA MD TOPO RETO 12,0X30', 'UP210-S4-12030', 'fresa'),
    ('SUPORTE INTERNO S12M STFCR', 'PS12MSTFCR11', 'suporte'),
    ('SUPORTE INTERNO S20R STFCR', 'PS20RSTFCR11', 'suporte'),
    ('PASTILHA 22ERN60 TC GM3225', 'P22ERN60-TC-GM3225', 'pastilha'),
    ('FRESA MD ESF. 3,0X6/50,0X6', 'UP210-B2-63006', 'fresa'),
    ('FRESA MD ESF. 10,0X18/75,0', 'UP210-B4-10018', 'fresa'),
    ('PASTILHA HNGU060432 GL GM4', 'PHNGU060432-GL-GM413', 'pastilha'),
    ('PASTILHA TCGX 16T304 AL GN', 'PTCGX16T304-AL-GN912', 'pastilha'),
    ('PASTILHA GKD 3004 MT GA423', 'PGKD3004-MT-GA4230', 'pastilha'),
    ('PASTILHA TNMG 160404 SF GS', 'PTNMG160404-SF-GS311', 'pastilha'),
    ('PASTILHA TCMT110208 GP GP1', 'PTCMT110208-GP-GP122', 'pastilha'),
    ('PASTILHA TNMG 160408L SV G', 'PTNMG160408L-SV-GP12', 'pastilha'),
    ('PASTILHA WNMG 080408 QM GP', 'PWNMG080408-QM-GP113', 'pastilha'),
    ('PASTILHA 16ER1.50ISO TC GM', 'P16ER1.50ISO-TC-GM32', 'pastilha'),
    ('PASTILHA APMT 1604PDER PM', 'PAPMT1604PDER-PM-GA', 'pastilha'),
    ('PASTILHA 16ER14W TC GM3225', 'P16ER14W-TC-GM3225', 'pastilha'),
    ('PASTILHA DCMT11T304 TP GP3', 'PDCMT11T304-TP-GP31T', 'pastilha'),
    ('SUPORTE EXTERNO MTJNL 2525', 'PMTJNL2525M16', 'suporte'),
    ('PASTILHA TCMT110204 MM GS3', 'PTCMT110204-MM-GS311', 'pastilha'),
    ('PASTILHA VCMT 160404 MM G', 'PVCMT160404-MM-GS311', 'pastilha'),
    ('SUPORTE EXTERNO MWLNL 2525', 'PMWLNL2525M08', 'suporte'),
    ('PASTILHA WNGU 080608 GM GA', 'PWNGU080608-GM-GA423', 'pastilha'),
    ('SUPORTE DE FRESA MEE190050', 'MEE190-050R05A22-WN0', 'suporte'),
    ('FRESA MD ESF. 2,0X4/50,0X6', 'UP210-B2-62004', 'fresa'),
    ('MACHO MAQ. CANAL HELICOIDA', 'PQBMNSU0601006HX99RA', 'macho'),
    ('MACHO MAQ. CANAL HELICOIDA', 'PQBMNSU0801256HX99RA', 'macho'),
    ('BROCA TMAX GHD-385-2D-FC40', 'PGHD3852DFC40Q11SHB', 'broca'),
    ('PASTILHA QPMG 110408 DP GA', 'PQPMG110408-DP-GA423', 'pastilha'),
    ('BROCA TMAX GHD-440-3D-FC40', 'PGHD4403DFC40Q13ADB', 'broca'),
    ('PASTILHA QPMG 130408 DP GA', 'PQPMG130408-DP-GA423', 'pastilha'),
    ('FRESA MD TOPO RETO 18,X45/', 'UP210-S4-18045', 'fresa'),
    ('PASTILHA SPMG 050204 DM GA', 'PSPMG050204-DM-GA423', 'pastilha'),
    ('SUPORTE DE FRESA MEA190020', 'MEA190-020R02P20-AP1', 'suporte'),
    ('FRESA MD TOROIDAL 6,0X16/5', 'SP210-R4-06010', 'fresa'),
    ('PASTILHA TNMG 160404R SV G', 'PTNMG160404R-SV-GP11', 'pastilha'),
    ('FRESA MD TOROIDAL 8,0X20/6', 'SP210-R4-08010', 'fresa'),
    ('PASTILHA APMT 1135PDER PM', 'PAPMT1135PDER-PM-GA4', 'pastilha');

-- Criação de stored procedure para atualização segura de produtos
DELIMITER //
CREATE PROCEDURE atualizar_produto(
    IN p_id INT,
    IN p_nome VARCHAR(255),
    IN p_referencia VARCHAR(100),
    IN p_categoria VARCHAR(50),
    IN p_preco DECIMAL(10,2),
    IN p_estoque INT,
    IN p_usuario VARCHAR(100)
)
BEGIN
    DECLARE old_data JSON;
    
    -- Salva dados antigos
    SELECT JSON_OBJECT(
        'nome', nome,
        'referencia', referencia,
        'categoria', categoria,
        'preco', preco,
        'estoque', estoque
    ) INTO old_data
    FROM produtos
    WHERE id = p_id;
    
    -- Atualiza produto
    UPDATE produtos 
    SET 
        nome = p_nome,
        referencia = p_referencia,
        categoria = p_categoria,
        preco = p_preco,
        estoque = p_estoque,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = p_id;
    
    -- Registra log
    INSERT INTO produtos_log (
        produto_id,
        acao,
        dados_antigos,
        dados_novos,
        usuario
    ) VALUES (
        p_id,
        'UPDATE',
        old_data,
        JSON_OBJECT(
            'nome', p_nome,
            'referencia', p_referencia,
            'categoria', p_categoria,
            'preco', p_preco,
            'estoque', p_estoque
        ),
        p_usuario
    );
END //
DELIMITER ;

-- Criação de stored procedure para movimentação de estoque
DELIMITER //
CREATE PROCEDURE movimentar_estoque(
    IN p_produto_id INT,
    IN p_tipo_movimento ENUM('entrada', 'saida'),
    IN p_quantidade INT,
    IN p_observacao TEXT
)
BEGIN
    DECLARE atual_estoque INT;
    
    -- Verifica estoque atual
    SELECT estoque INTO atual_estoque
    FROM produtos
    WHERE id = p_produto_id;
    
    -- Valida quantidade para saída
    IF p_tipo_movimento = 'saida' AND atual_estoque < p_quantidade THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Estoque insuficiente';
    END IF;
    
    -- Atualiza estoque
    UPDATE produtos 
    SET estoque = CASE 
        WHEN p_tipo_movimento = 'entrada' THEN estoque + p_quantidade
        ELSE estoque - p_quantidade
    END
    WHERE id = p_produto_id;
    
    -- Registra movimentação
    INSERT INTO movimentacao_estoque (
        produto_id,
        tipo_movimento,
        quantidade,
        observacao
    ) VALUES (
        p_produto_id,
        p_tipo_movimento,
        p_quantidade,
        p_observacao
    );
END //
DELIMITER ; 